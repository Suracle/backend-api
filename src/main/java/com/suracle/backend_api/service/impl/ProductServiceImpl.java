import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
package com.suracle.backend_api.service.impl;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;

import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.fasterxml.jackson.core.JsonProcessingException;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.dto.product.ProductListResponseDto;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.dto.product.ProductRequestDto;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.dto.product.ProductResponseDto;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.dto.precedents.PrecedentsResponseDto;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.entity.cache.ProductAnalysisCache;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.entity.product.Product;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.entity.product.enums.ProductStatus;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.entity.user.User;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.repository.ProductAnalysisCacheRepository;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.repository.ProductRepository;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.repository.UserRepository;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.repository.HsCodeRepository;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.service.ProductService;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import com.suracle.backend_api.service.ProductAnalysisService;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import lombok.RequiredArgsConstructor;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import org.springframework.data.domain.Page;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import org.springframework.data.domain.Pageable;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import java.util.HashMap;

import java.util.List;
import java.util.Map;
import java.util.Optional;

@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class ProductServiceImpl implements ProductService {

    private final ProductRepository productRepository;
    private final UserRepository userRepository;
    private final HsCodeRepository hsCodeRepository;
    private final ProductAnalysisService productAnalysisService;
    private final ProductAnalysisCacheRepository productAnalysisCacheRepository;
    private final ObjectMapper objectMapper;
    private final RestTemplate restTemplate;
    
    @Value("${ai.engine.base-url}")
    private String aiEngineBaseUrl;

    @Override
    public ProductResponseDto createProduct(ProductRequestDto productRequestDto, Integer sellerId) {
        log.info("상품 등록 요청 - 판매자 ID: {}, 상품명: {}, 가격: {}, FOB가격: {}", 
                sellerId, productRequestDto.getProductName(), productRequestDto.getPrice(), productRequestDto.getFobPrice());

        // 판매자 존재 확인
        User seller = userRepository.findById(sellerId)
                .orElseThrow(() -> {
                    log.error("존재하지 않는 판매자 ID: {}", sellerId);
                    return new IllegalArgumentException("존재하지 않는 판매자입니다: " + sellerId);
                });

        // 상품 ID 생성 (UUID 기반)
        String productId = generateProductId();

        // Product 엔티티 생성
        Product savedProduct;
        try {
            Product product = Product.builder()
                    .seller(seller)
                    .productId(productId)
                    .productName(productRequestDto.getProductName())
                    .description(productRequestDto.getDescription())
                    .price(productRequestDto.getPrice())
                    .fobPrice(productRequestDto.getFobPrice())
                    .originCountry(productRequestDto.getOriginCountry())
                    .hsCode(productRequestDto.getHsCode())
                    .status(productRequestDto.getStatus() != null ? productRequestDto.getStatus() : ProductStatus.DRAFT)
                    .isActive(productRequestDto.getIsActive() != null ? productRequestDto.getIsActive() : true)
                    .build();

            log.info("Product 엔티티 생성 완료 - ID: {}, 상품명: {}, 가격: {}, FOB가격: {}", 
                    productId, product.getProductName(), product.getPrice(), product.getFobPrice());

            // 상품 저장
            savedProduct = productRepository.save(product);
            log.info("상품 저장 완료 - DB ID: {}, 상품 ID: {}", savedProduct.getId(), savedProduct.getProductId());
        } catch (Exception e) {
            log.error("Product 엔티티 생성 또는 저장 중 오류 발생 - 판매자 ID: {}, 상품명: {}, 오류: {}", 
                     sellerId, productRequestDto.getProductName(), e.getMessage(), e);
            throw e;
        }
        
        log.info("상품 등록 완료 - 상품 ID: {}, 상품명: {}", savedProduct.getProductId(), savedProduct.getProductName());

        // 백그라운드 분석 스케줄링 (HS코드가 있는 경우에만)
        if (savedProduct.getHsCode() != null && !savedProduct.getHsCode().trim().isEmpty()) {
            productAnalysisService.scheduleBackgroundAnalysis(savedProduct);
        }

        return convertToProductResponseDto(savedProduct);
    }

    @Override
    @Transactional(readOnly = true)
    public Page<ProductListResponseDto> getProducts(Pageable pageable) {
        log.info("상품 목록 조회 요청 - 페이지: {}, 크기: {}", pageable.getPageNumber(), pageable.getPageSize());

        Page<Product> products = productRepository.findByIsActiveTrue(pageable);
        return products.map(this::convertToProductListResponseDto);
    }

    @Override
    @Transactional(readOnly = true)
    public ProductResponseDto getProductById(String productId) {
        log.info("상품 상세 조회 요청 - 상품 ID: {}", productId);

        Product product = productRepository.findByProductId(productId)
                .orElseThrow(() -> new IllegalArgumentException("존재하지 않는 상품입니다: " + productId));

        if (!product.getIsActive()) {
            throw new IllegalArgumentException("비활성화된 상품입니다: " + productId);
        }

        return convertToProductResponseDto(product);
    }

    @Override
    public void deleteProduct(String productId, Integer sellerId) {
        log.info("상품 삭제 요청 - 상품 ID: {}, 판매자 ID: {}", productId, sellerId);

        Product product = productRepository.findByProductId(productId)
                .orElseThrow(() -> new IllegalArgumentException("존재하지 않는 상품입니다: " + productId));

        // 권한 확인 (본인 상품인지 확인)
        if (!product.getSeller().getId().equals(sellerId)) {
            throw new IllegalArgumentException("상품 삭제 권한이 없습니다");
        }

        // 논리 삭제 (isActive를 false로 변경)
        product.setIsActive(false);
        productRepository.save(product);

        log.info("상품 삭제 완료 - 상품 ID: {}", productId);
    }


    @Override
    @Transactional(readOnly = true)
    public Page<ProductListResponseDto> searchProductsByName(String productName, Pageable pageable) {
        log.info("상품명 검색 요청 - 검색어: {}, 페이지: {}", productName, pageable.getPageNumber());

        Page<Product> products = productRepository.findByProductNameContaining(productName, pageable);
        return products.map(this::convertToProductListResponseDto);
    }


    @Override
    @Transactional(readOnly = true)
    public Page<ProductListResponseDto> searchProductsBySellerIdAndNameAndStatus(Integer sellerId, String productName, String status, Pageable pageable) {
        log.info("판매자별 상품 검색 요청 (상품명 + 상태 필터) - 판매자 ID: {}, 검색어: {}, 상태: {}, 페이지: {}", sellerId, productName, status, pageable.getPageNumber());

        // 상태 필터 처리
        ProductStatus productStatus = null;
        if (status != null && !status.equals("all") && !status.isEmpty()) {
            try {
                productStatus = ProductStatus.valueOf(status);
            } catch (IllegalArgumentException e) {
                log.warn("잘못된 상품 상태: {}", status);
                throw new IllegalArgumentException("잘못된 상품 상태입니다: " + status);
            }
        }

        // 검색어 처리 (null이거나 빈 문자열이면 전체 상품명으로 처리)
        String searchTerm = (productName == null || productName.trim().isEmpty()) ? null : productName;

        Page<Product> products = productRepository.findBySellerIdAndProductNameContainingAndStatusAndIsActiveTrue(sellerId, searchTerm, productStatus, pageable);
        return products.map(this::convertToProductListResponseDto);
    }

    @Override
    @Transactional(readOnly = true)
    @Override
    @Transactional(readOnly = true)
    public PrecedentsResponseDto getProductPrecedents(String productId) {
        log.info("상품 판례 분석 조회 요청 - 상품 ID: {}", productId);

        // 상품 존재 확인
        Product product = productRepository.findByProductId(productId)
                .orElseThrow(() -> new IllegalArgumentException("존재하지 않는 상품입니다: " + productId));

        // 1. 캐시에서 먼저 확인
        Optional<ProductAnalysisCache> cache = productAnalysisCacheRepository
                .findByProductIdAndAnalysisType(product.getId(), "precedents");
        
        if (cache.isPresent()) {
            log.info("캐시에서 판례 분석 결과 반환 - 상품 ID: {}", productId);
            return parsePrecedentsFromCache(cache.get());
        }

        // 2. 캐시에 없으면 AI Engine 호출
        log.info("AI Engine에서 판례 분석 수행 - 상품 ID: {}", productId);
        try {
            // AI Engine에 분석 요청
            Map<String, Object> request = new HashMap<>();
            request.put("product_id", product.getProductId());
            request.put("product_name", product.getProductName());
            request.put("description", product.getDescription());
            request.put("hs_code", product.getHsCode());
            request.put("origin_country", product.getOriginCountry());
            request.put("price", product.getPrice());
            request.put("fob_price", product.getFobPrice());

            // HTTP 헤더 설정
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            // 요청 엔티티 생성
            HttpEntity<Map<String, Object>> requestEntity = new HttpEntity<>(request, headers);

            // AI Engine 호출
            String aiEngineUrl = aiEngineBaseUrl + "/analyze-precedents";
            Map<String, Object> response = restTemplate.postForObject(
                    aiEngineUrl, requestEntity, Map.class
            );

            if (response != null) {
                // 결과를 캐시에 저장
                saveAnalysisResult(product, "precedents", response);
                
                // 응답 변환하여 반환
                return convertToPrecedentsDto(response);
            } else {
                log.warn("AI Engine 응답이 null입니다 - 상품 ID: {}", productId);
                return getDefaultPrecedentsResponse();
            }

        } catch (Exception e) {
            log.error("AI Engine 호출 실패 - 상품 ID: {}", productId, e);
            // 실패 시 기본값 반환
            return getDefaultPrecedentsResponse();
        }
    }

    private PrecedentsResponseDto parsePrecedentsFromCache(ProductAnalysisCache cache) {
        try {
            Map<String, Object> analysisResult = objectMapper.readValue(
                    cache.getAnalysisResult(), Map.class
            );
            
            return PrecedentsResponseDto.builder()
                    .successCases((List<String>) analysisResult.get("success_cases"))
                    .failureCases((List<String>) analysisResult.get("failure_cases"))
                    .actionableInsights((List<String>) analysisResult.get("actionable_insights"))
                    .riskFactors((List<String>) analysisResult.get("risk_factors"))
                    .recommendedAction((String) analysisResult.get("recommended_action"))
                    .confidenceScore(cache.getConfidenceScore().doubleValue())
                    .isValid(cache.getIsValid())
                    .build();
        } catch (JsonProcessingException e) {
            log.error("캐시 데이터 파싱 오류", e);
            return getDefaultPrecedentsResponse();
        }
    }

    private void saveAnalysisResult(Product product, String analysisType, Map<String, Object> result) {
        try {
            String analysisResultJson = objectMapper.writeValueAsString(result);
            
            ProductAnalysisCache cache = ProductAnalysisCache.builder()
                    .product(product)
                    .analysisType(analysisType)
                    .analysisResult(analysisResultJson)
                    .confidenceScore(java.math.BigDecimal.valueOf((Double) result.getOrDefault("confidence_score", 0.5)))
                    .isValid((Boolean) result.getOrDefault("is_valid", true))
                    .build();
            
            productAnalysisCacheRepository.save(cache);
            log.info("분석 결과 캐시 저장 완료 - 상품 ID: {}, 분석 타입: {}", product.getProductId(), analysisType);
        } catch (Exception e) {
            log.error("분석 결과 캐시 저장 실패", e);
        }
    }

    private PrecedentsResponseDto convertToPrecedentsDto(Map<String, Object> response) {
        return PrecedentsResponseDto.builder()
                .successCases((List<String>) response.getOrDefault("success_cases", List.of()))
                .failureCases((List<String>) response.getOrDefault("failure_cases", List.of()))
                .actionableInsights((List<String>) response.getOrDefault("actionable_insights", List.of()))
                .riskFactors((List<String>) response.getOrDefault("risk_factors", List.of()))
                .recommendedAction((String) response.getOrDefault("recommended_action", "분석 결과 없음"))
                .confidenceScore((Double) response.getOrDefault("confidence_score", 0.5))
                .isValid((Boolean) response.getOrDefault("is_valid", false))
                .build();
    }

    private PrecedentsResponseDto getDefaultPrecedentsResponse() {
        return PrecedentsResponseDto.builder()
                .successCases(List.of("분석을 위해 추가 데이터가 필요합니다"))
                .failureCases(List.of("일반적인 수입 거부 사유를 확인하세요"))
                .actionableInsights(List.of("FDA 인증서 준비", "HS코드 정확성 확인"))
                .riskFactors(List.of("규제 변경 가능성", "문서 부족"))
                .recommendedAction("전문가 상담 권장")
                .confidenceScore(0.3)
                .isValid(false)
                .build();
    }
        return ProductResponseDto.builder()
                .id(product.getId())
                .sellerId(product.getSeller().getId())
                .sellerName(product.getSeller().getUserName())
                .productId(product.getProductId())
                .productName(product.getProductName())
                .description(product.getDescription())
                .price(product.getPrice())
                .fobPrice(product.getFobPrice())
                .originCountry(product.getOriginCountry())
                .hsCode(product.getHsCode())
                .hsCodeDescription(hsCodeDescription)
                .status(product.getStatus())
                .isActive(product.getIsActive())
                .createdAt(product.getCreatedAt())
                .updatedAt(product.getUpdatedAt())
                .build();
    }

    @Override
    public Optional<ProductResponseDto> getProductById(Integer id) {
        log.info("상품 조회 요청 (숫자 ID) - ID: {}", id);
        
        return productRepository.findById(id)
                .map(this::convertToProductResponseDto);
    }

    /**
     * Product 엔티티를 ProductListResponseDto로 변환
     */
    private ProductListResponseDto convertToProductListResponseDto(Product product) {
        return ProductListResponseDto.builder()
                .id(product.getId())
                .sellerId(product.getSeller().getId())
                .sellerName(product.getSeller().getUserName())
                .productId(product.getProductId())
                .productName(product.getProductName())
                .price(product.getPrice())
                .fobPrice(product.getFobPrice())
                .originCountry(product.getOriginCountry())
                .hsCode(product.getHsCode())
                .status(product.getStatus())
                .isActive(product.getIsActive())
                .createdAt(product.getCreatedAt())
                .build();
    }
}
